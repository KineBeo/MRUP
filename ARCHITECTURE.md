# MRUP Oracle Architecture (Updated: Phase 1 & 2 Complete)

## ğŸ“Š Current Implementation Status

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MRUP Oracle Progress                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Phase 1: Schema & Data Generation          [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%   â”‚
â”‚    - Custom table pair generator                                â”‚
â”‚    - MRUP-compliant schema                                      â”‚
â”‚    - Disjoint partition data                                    â”‚
â”‚    - Partition validation                                       â”‚
â”‚                                                                  â”‚
â”‚ âœ… Phase 2: Window Function Generation         [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%   â”‚
â”‚    - C0: PARTITION BY mandatory                                 â”‚
â”‚    - C1-C5: All constraints enforced                            â”‚
â”‚    - OSRB algorithm                                             â”‚
â”‚    - Mutation operators                                         â”‚
â”‚                                                                  â”‚
â”‚ â³ Phase 3: MRUP Normalization                 [        ]   0%   â”‚
â”‚    - Fix sortResults() method                                   â”‚
â”‚    - Implement MRUP normalization                               â”‚
â”‚    - Per-partition comparison                                   â”‚
â”‚    - Extract window spec info                                   â”‚
â”‚                                                                  â”‚
â”‚ Overall Progress:                              [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   ]  67%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Quick Stats

| Metric | Value |
|--------|-------|
| **Lines of Code** | ~2000+ |
| **Files Created** | 4 (Oracle, Generator, Mutation, BugReproducer) |
| **Constraints Enforced** | 6 (C0-C5) |
| **False Positive Rate** | ~10-20% (Phase 3 will reduce to <5%) |
| **Mutation Strategies** | 10 implemented |
| **Window Functions** | 8 (deterministic only) |
| **Test Coverage** | Schema âœ…, Window Gen âœ…, Comparison â³ |

---

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SQLancer Framework                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              SQLite3Provider                            â”‚    â”‚
â”‚  â”‚  - Database creation                                    â”‚    â”‚
â”‚  â”‚  - Basic table generation (NOT USED for MRUP)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          SQLite3OracleFactory                          â”‚    â”‚
â”‚  â”‚  - PQS, NoREC, TLP oracles                            â”‚    â”‚
â”‚  â”‚  - MRUP  â† NEW! (Phase 1 & 2 Complete)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          SQLite3MRUPOracle (Main Oracle)              â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  check() - Main Oracle Logic                 â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  1. Generate MRUP table pair (t1, t2)       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  2. Log table schema & data                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  3. Generate window function (OSRB + C0-C5)  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  4. Log window function & constraints        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  5. Build & log queries (Q1, Q2, Q_union)   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  6. Execute queries & get results            â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  7. Compare results (cardinality + values)   â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Logging Methods (Centralized)               â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - logTableInfo()                            â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - displayTableData()                        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - verifyDisjointPartitions()                â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - logWindowFunctionGeneration()             â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - logQueries()                              â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Window Function Generation (Phase 2)        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - generateWindowSpecOSRB()                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C0: PARTITION BY dept (MANDATORY)       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C1: Only 'dept' for PARTITION BY        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C2: Only salary/age for ORDER BY        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - generateFrameClause()                     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C3: No frames for ranking functions     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C4: RANGE only with single ORDER BY     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - generateWindowFunction()                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    * C5: Only deterministic functions        â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Query Building & Execution                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - buildWindowQuery()                        â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - buildWindowQueryOnUnion()                 â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - executeAndGetResults()                    â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Comparison Logic (Current - Phase 3 TODO)   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - sortResults() [NEEDS FIX]                 â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - resultsMatch()                            â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - findFirstDifference()                     â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Bug Reporting                               â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - SQLite3MRUPBugReproducer                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - Generates standalone SQL scripts          â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - Saves to bug_reports/ folder              â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  Mutation Operators (Optional)               â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - SQLite3MRUPMutationOperator               â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  - Top 10 mutation strategies                â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    SQLite3MRUPTablePairGenerator (Phase 1)            â”‚    â”‚
â”‚  â”‚    - Custom table pair generation                      â”‚    â”‚
â”‚  â”‚    - MRUP-compliant schema (dept, salary, age, c0, c1)â”‚    â”‚
â”‚  â”‚    - Disjoint partition data generation                â”‚    â”‚
â”‚  â”‚    - Partition validation                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              SQLite3 Database                          â”‚    â”‚
â”‚  â”‚  - Execute queries                                     â”‚    â”‚
â”‚  â”‚  - Return results                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Complete Data Flow (Phase 1 & 2 Implementation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Start     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: Generate MRUP Table Pair (Custom Generator)            â”‚
â”‚  SQLite3MRUPTablePairGenerator.generateMRUPTablePair()           â”‚
â”‚                                                                   â”‚
â”‚  Step 1.1: Define MRUP Schema                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Mandatory columns:                                      â”‚     â”‚
â”‚  â”‚  - dept TEXT (partition key - DISJOINT)                â”‚     â”‚
â”‚  â”‚  - salary INTEGER (order key 1)                        â”‚     â”‚
â”‚  â”‚ Optional columns (0-2):                                 â”‚     â”‚
â”‚  â”‚  - age INTEGER (order key 2)                           â”‚     â”‚
â”‚  â”‚  - c0 TEXT/INTEGER/REAL                                â”‚     â”‚
â”‚  â”‚  - c1 TEXT/INTEGER/REAL                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 1.2: Create Tables with Same Schema                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CREATE TABLE t1 (dept TEXT, salary INT, ...)          â”‚     â”‚
â”‚  â”‚ CREATE TABLE t2 (dept TEXT, salary INT, ...)          â”‚     â”‚
â”‚  â”‚ (Ensure t1 != t2 by name)                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 1.3: Generate DISJOINT Partition Data                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ t1 partitions: Set A = {Finance, Engineering, HR}     â”‚     â”‚
â”‚  â”‚ t2 partitions: Set B = {Sales, Marketing, Operations} â”‚     â”‚
â”‚  â”‚ Constraint: A âˆ© B = âˆ… (NO OVERLAP!)                   â”‚     â”‚
â”‚  â”‚ NULL partition: Only in t1 (if present)               â”‚     â”‚
â”‚  â”‚ Row count: 5-20 rows per table                        â”‚     â”‚
â”‚  â”‚ Salary: Rounded to 5000 (creates duplicates)          â”‚     â”‚
â”‚  â”‚ Age: 20-65 range                                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 1.4: Validate Disjoint Partitions                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Assert: t1.dept âˆ© t2.dept = âˆ…                         â”‚     â”‚
â”‚  â”‚ If overlap found â†’ throw exception                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Result: t1 (5-20 rows), t2 (5-20 rows) with disjoint partitionsâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING: Display Table Info (Centralized)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ğŸ“‹ Schema: dept TEXT, salary INT, age INT             â”‚     â”‚
â”‚  â”‚ ğŸ“Š Table t1: [show all rows]                          â”‚     â”‚
â”‚  â”‚ ğŸ“Š Table t2: [show all rows]                          â”‚     â”‚
â”‚  â”‚ âœ“ Partition Verification:                             â”‚     â”‚
â”‚  â”‚   t1: {Finance, Engineering, HR}                      â”‚     â”‚
â”‚  â”‚   t2: {Sales, Marketing, Operations}                  â”‚     â”‚
â”‚  â”‚   Overlap: NONE âœ“ | Status: DISJOINT âœ“               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: Generate Window Function (OSRB + Constraints)          â”‚
â”‚                                                                   â”‚
â”‚  Step 2.1: Select Function Type (C5: Deterministic only)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Ranking: ROW_NUMBER, RANK, DENSE_RANK                 â”‚     â”‚
â”‚  â”‚ Aggregate: SUM, AVG, COUNT, MIN, MAX                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 2.2: Generate OVER() Clause                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ C0: PARTITION BY dept (MANDATORY - 100%)              â”‚     â”‚
â”‚  â”‚     â””â”€ C1: Only 'dept' column allowed                 â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ ORDER BY (ALWAYS)                                      â”‚     â”‚
â”‚  â”‚     â””â”€ C2: Only 'salary' or 'age' columns             â”‚     â”‚
â”‚  â”‚     â””â”€ Optional: ASC/DESC, NULLS FIRST/LAST           â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ FRAME (Conditional)                                    â”‚     â”‚
â”‚  â”‚     â””â”€ C3: Only for aggregate functions                â”‚     â”‚
â”‚  â”‚     â””â”€ C4: RANGE only with single ORDER BY            â”‚     â”‚
â”‚  â”‚     â””â”€ ROWS/RANGE + boundaries + EXCLUDE              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 2.3: Apply Mutations (Optional, 50% chance)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Top 10 mutation strategies:                            â”‚     â”‚
â”‚  â”‚ - Redundant ORDER BY (x, x)                           â”‚     â”‚
â”‚  â”‚ - Order-preserving transform (x+0)                    â”‚     â”‚
â”‚  â”‚ - Add redundant PARTITION BY key                      â”‚     â”‚
â”‚  â”‚ - etc.                                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Result: "ROW_NUMBER() OVER (PARTITION BY dept ORDER BY salary)" â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING: Display Window Function & Constraints                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ğŸ¯ Generated: ROW_NUMBER() OVER (...)                 â”‚     â”‚
â”‚  â”‚ ğŸ“‹ Constraint Verification:                            â”‚     â”‚
â”‚  â”‚   [C0] PARTITION BY is MANDATORY:        âœ“ PASS       â”‚     â”‚
â”‚  â”‚   [C1] PARTITION BY only uses 'dept':    âœ“ PASS       â”‚     â”‚
â”‚  â”‚   [C2] ORDER BY only uses salary/age:    âœ“ PASS       â”‚     â”‚
â”‚  â”‚   [C3] No FRAME for ranking functions:   âœ“ PASS       â”‚     â”‚
â”‚  â”‚   [C4] RANGE only with single ORDER BY:  âœ“ PASS       â”‚     â”‚
â”‚  â”‚   [C5] Only deterministic functions:     âœ“ PASS       â”‚     â”‚
â”‚  â”‚ ğŸ”„ Mutation: [if applied]                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Build Queries                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Q1 = SELECT dept, salary, age,                        â”‚     â”‚
â”‚  â”‚      ROW_NUMBER() OVER (...) AS wf_result             â”‚     â”‚
â”‚  â”‚      FROM t1                                           â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ Q2 = SELECT dept, salary, age,                        â”‚     â”‚
â”‚  â”‚      ROW_NUMBER() OVER (...) AS wf_result             â”‚     â”‚
â”‚  â”‚      FROM t2                                           â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ Q_union = SELECT dept, salary, age,                   â”‚     â”‚
â”‚  â”‚           ROW_NUMBER() OVER (...) AS wf_result        â”‚     â”‚
â”‚  â”‚           FROM (SELECT * FROM t1                      â”‚     â”‚
â”‚  â”‚                 UNION ALL                              â”‚     â”‚
â”‚  â”‚                 SELECT * FROM t2) AS t_union          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING: Display Queries                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ğŸ“ Q1 (on t1): [full query]                           â”‚     â”‚
â”‚  â”‚ ğŸ“ Q2 (on t2): [full query]                           â”‚     â”‚
â”‚  â”‚ ğŸ“ Q_union (on t1 UNION ALL t2): [full query]         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Execute Queries & Get Results                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Execute Q1 â†’ results1 (List<List<String>>)            â”‚     â”‚
â”‚  â”‚   e.g., [[Finance, 50000, 30, 1],                     â”‚     â”‚
â”‚  â”‚          [Finance, 80000, 40, 2],                     â”‚     â”‚
â”‚  â”‚          [Engineering, 60000, 35, 1]]                 â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ Execute Q2 â†’ results2 (List<List<String>>)            â”‚     â”‚
â”‚  â”‚   e.g., [[Sales, 70000, 28, 1],                       â”‚     â”‚
â”‚  â”‚          [Marketing, 90000, 45, 1]]                   â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚ Execute Q_union â†’ resultsUnion (List<List<String>>)   â”‚     â”‚
â”‚  â”‚   e.g., [[Finance, 50000, 30, 1],                     â”‚     â”‚
â”‚  â”‚          [Finance, 80000, 40, 2],                     â”‚     â”‚
â”‚  â”‚          [Engineering, 60000, 35, 1],                 â”‚     â”‚
â”‚  â”‚          [Sales, 70000, 28, 1],                       â”‚     â”‚
â”‚  â”‚          [Marketing, 90000, 45, 1]]                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: Compare Results (CURRENT - NEEDS PHASE 3 FIX!)          â”‚
â”‚                                                                   â”‚
â”‚  Step 5.1: Check Cardinality                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ expectedCount = results1.size() + results2.size()      â”‚     â”‚
â”‚  â”‚ actualCount = resultsUnion.size()                      â”‚     â”‚
â”‚  â”‚ If expectedCount != actualCount â†’ BUG!                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 5.2: Sort Results (âš ï¸ INCORRECT - PHASE 3 TODO)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ âŒ Current: Sort by ALL columns (lexicographic)        â”‚     â”‚
â”‚  â”‚ âœ… Correct: Sort by partition â†’ ORDER BY â†’ row_number  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 5.3: Compare Row-by-Row                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ expected = results1 + results2 (concatenated)          â”‚     â”‚
â”‚  â”‚ actual = resultsUnion                                  â”‚     â”‚
â”‚  â”‚ For each row: compare all columns                      â”‚     â”‚
â”‚  â”‚ If any mismatch â†’ BUG!                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Step 5.4: Generate Bug Report (if mismatch)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ SQLite3MRUPBugReproducer.generateBugReport()          â”‚     â”‚
â”‚  â”‚ - Extract table schemas                                â”‚     â”‚
â”‚  â”‚ - Extract table data                                   â”‚     â”‚
â”‚  â”‚ - Include Q1, Q2, Q_union                             â”‚     â”‚
â”‚  â”‚ - Save to bug_reports/bug_report_<timestamp>.sql      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                   â”‚
â”‚  Result: PASS âœ… or BUG FOUND âŒ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     End     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase 3: What Needs to Be Fixed (MRUP Normalization)

### Current Problem

The current comparison logic sorts by **ALL columns** (lexicographic), which is **INCORRECT** for MRUP:

```java
// âŒ CURRENT (WRONG):
private void sortResults(List<List<String>> results) {
    results.sort((row1, row2) -> {
        for (int i = 0; i < Math.min(row1.size(), row2.size()); i++) {
            int cmp = row1.get(i).compareTo(row2.get(i));
            if (cmp != 0) return cmp;
        }
        return Integer.compare(row1.size(), row2.size());
    });
}
```

**Why this is wrong:**
- Sorts by ALL columns including non-window columns (dept, salary, age, wf_result)
- Changes the logical order within partitions
- Causes false positives when window function results are correct but ordered differently

### Correct MRUP Normalization Rule

```
Sort each result set by:
1. Partition key (dept)
2. Window ORDER BY keys (salary, age) in correct order
3. Synthetic row_number or stable tie-breaker
4. NOTHING ELSE!
```

### Example: Why Current Sorting Fails

**Scenario:** `ROW_NUMBER() OVER (PARTITION BY dept ORDER BY salary)`

**Q1 Result (Finance partition):**
```
dept     | salary | wf_result
---------|--------|----------
Finance  | 50000  | 1
Finance  | 80000  | 2
```

**Q2 Result (Sales partition):**
```
dept     | salary | wf_result
---------|--------|----------
Sales    | 70000  | 1
```

**Q_union Result (correct):**
```
dept     | salary | wf_result
---------|--------|----------
Finance  | 50000  | 1
Finance  | 80000  | 2
Sales    | 70000  | 1
```

**Current sorting (by ALL columns):**
```
Expected: [Finance, 50000, 1], [Finance, 80000, 2], [Sales, 70000, 1]
Actual:   [Finance, 50000, 1], [Finance, 80000, 2], [Sales, 70000, 1]
âœ“ MATCH (by luck!)
```

**But with different data:**
```
Q1: [Finance, 80000, 1], [Finance, 50000, 2]  (ORDER BY salary DESC)
Q2: [Sales, 70000, 1]

Current sort by ALL columns:
Expected: [Finance, 50000, 2], [Finance, 80000, 1], [Sales, 70000, 1]
Actual:   [Finance, 50000, 2], [Finance, 80000, 1], [Sales, 70000, 1]
âœ— FALSE POSITIVE! (wf_result order is wrong)
```

**Correct MRUP normalization (by partition + ORDER BY + rn):**
```
Expected: [Finance, 80000, 1], [Finance, 50000, 2], [Sales, 70000, 1]
Actual:   [Finance, 80000, 1], [Finance, 50000, 2], [Sales, 70000, 1]
âœ“ CORRECT MATCH!
```

### Phase 3 Implementation Plan

1. **Extract Window Specification Info**
   - Parse PARTITION BY column(s)
   - Parse ORDER BY column(s) and direction (ASC/DESC, NULLS FIRST/LAST)
   - Store for normalization

2. **Implement MRUP Normalization**
   ```java
   private void normalizeForMRUP(List<List<String>> results, 
                                  String partitionCol, 
                                  List<String> orderByCols,
                                  List<String> orderByDirections) {
       results.sort((row1, row2) -> {
           // 1. Compare partition key
           int partitionCmp = compareColumn(row1, row2, partitionCol);
           if (partitionCmp != 0) return partitionCmp;
           
           // 2. Compare ORDER BY keys in order
           for (int i = 0; i < orderByCols.size(); i++) {
               int cmp = compareColumn(row1, row2, orderByCols.get(i));
               if (orderByDirections.get(i).equals("DESC")) cmp = -cmp;
               if (cmp != 0) return cmp;
           }
           
           // 3. Compare window function result (row_number)
           int wfCmp = compareColumn(row1, row2, "wf_result");
           return wfCmp;
       });
   }
   ```

3. **Per-Partition Comparison**
   - Group results by partition
   - Compare each partition separately
   - Ensure disjoint partitions don't merge

4. **Handle NULL Values Correctly**
   - NULLS FIRST/LAST from ORDER BY
   - NULL partition handling

### Expected Impact

- **False positive rate:** From ~10-20% â†’ <5%
- **Real bug detection:** Enabled (no more noise)
- **MRUP correctness:** Guaranteed (metamorphic relation holds)

---

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SQLancer Main Loop                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Create Database             â”‚
        â”‚   Generate Tables (t1, t2...) â”‚
        â”‚   Insert Data                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Call Oracle.check()         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SQLite3MRUPOracle.check()                      â”‚
â”‚                                                               â”‚
â”‚  1. schema.getDatabaseTables()                               â”‚
â”‚     â†“                                                         â”‚
â”‚  2. Select t1, t2 randomly                                   â”‚
â”‚     â†“                                                         â”‚
â”‚  3. Get columns from t1                                      â”‚
â”‚     â†“                                                         â”‚
â”‚  4. generateWindowSpecOSRB(columns)                          â”‚
â”‚     â”œâ”€â†’ generateFrameClause() (if needed)                    â”‚
â”‚     â””â”€â†’ Returns: "OVER (...)"                               â”‚
â”‚     â†“                                                         â”‚
â”‚  5. generateWindowFunction(column, windowSpec)               â”‚
â”‚     â””â”€â†’ Returns: "ROW_NUMBER() OVER (...)"                  â”‚
â”‚     â†“                                                         â”‚
â”‚  6. buildWindowQuery(t1, columns, windowFunction)            â”‚
â”‚     â””â”€â†’ Returns: "SELECT ..., WF FROM t1"                   â”‚
â”‚     â†“                                                         â”‚
â”‚  7. buildWindowQuery(t2, columns, windowFunction)            â”‚
â”‚     â””â”€â†’ Returns: "SELECT ..., WF FROM t2"                   â”‚
â”‚     â†“                                                         â”‚
â”‚  8. buildWindowQueryOnUnion(t1, t2, columns, windowFunction) â”‚
â”‚     â””â”€â†’ Returns: "SELECT ..., WF FROM (t1 UNION t2)"       â”‚
â”‚     â†“                                                         â”‚
â”‚  9. executeAndGetCardinality(q1)                             â”‚
â”‚     â”œâ”€â†’ Execute query                                        â”‚
â”‚     â”œâ”€â†’ Count rows                                           â”‚
â”‚     â”œâ”€â†’ Handle errors                                        â”‚
â”‚     â””â”€â†’ Returns: card1                                       â”‚
â”‚     â†“                                                         â”‚
â”‚ 10. executeAndGetCardinality(q2)                             â”‚
â”‚     â””â”€â†’ Returns: card2                                       â”‚
â”‚     â†“                                                         â”‚
â”‚ 11. executeAndGetCardinality(qUnion)                         â”‚
â”‚     â””â”€â†’ Returns: cardUnion                                   â”‚
â”‚     â†“                                                         â”‚
â”‚ 12. Compare: cardUnion == (card1 + card2)?                   â”‚
â”‚     â”œâ”€â†’ YES: Return (test passes)                           â”‚
â”‚     â””â”€â†’ NO:  throw AssertionError (bug found!)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## OSRB Algorithm Flow

```
generateWindowSpecOSRB(columns)
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Start: "OVER ("                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Random? â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â”‚       â”‚
   YES     NO
    â”‚       â”‚
    â†“       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Add PARTITION BY         â”‚  â”‚
â”‚ - Select 1-3 columns     â”‚  â”‚
â”‚ - Append column names    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
           â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add ORDER BY (always)        â”‚
â”‚ - Select 1-3 columns         â”‚
â”‚ - Add ASC/DESC (random)      â”‚
â”‚ - Add NULLS FIRST/LAST (50%) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚Random? â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚
      â”Œâ”€â”€â”€â”´â”€â”€â”€â”
      â”‚       â”‚
     YES     NO
      â”‚       â”‚
      â†“       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ Add FRAME clause         â”‚    â”‚
â”‚ - Call generateFrame()   â”‚    â”‚
â”‚ - ROWS/RANGE/GROUPS      â”‚    â”‚
â”‚ - Boundaries             â”‚    â”‚
â”‚ - EXCLUDE (50%)          â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
           â”‚                    â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Append ")"                   â”‚
â”‚ Return complete spec         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
executeAndGetCardinality(query)
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Statement               â”‚
â”‚ Execute query                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Success?â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â”‚       â”‚
   YES     NO (Exception)
    â”‚       â”‚
    â†“       â†“
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Countâ”‚  â”‚ Check error message  â”‚
â”‚rows â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”¬â”€â”€â”˜             â”‚
   â”‚            â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚            â”‚       â”‚
   â”‚        Expected  Unexpected
   â”‚            â”‚       â”‚
   â”‚            â†“       â†“
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚ Ignore  â”‚  â”‚ Rethrow  â”‚
   â”‚    â”‚(skip)   â”‚  â”‚(report)  â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Return count  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Class Hierarchy

```
TestOracle<SQLite3GlobalState>
    â†‘
    â”‚ implements
    â”‚
SQLite3MRUPOracle
    â”‚
    â”œâ”€ Fields:
    â”‚   â”œâ”€ globalState: SQLite3GlobalState
    â”‚   â”œâ”€ errors: ExpectedErrors
    â”‚   â””â”€ lastQueryString: String
    â”‚
    â”œâ”€ Public Methods:
    â”‚   â”œâ”€ check(): void
    â”‚   â””â”€ getLastQueryString(): String
    â”‚
    â””â”€ Private Methods:
        â”œâ”€ generateWindowSpecOSRB(columns): String
        â”œâ”€ generateFrameClause(): String
        â”œâ”€ generateWindowFunction(column, spec): String
        â”œâ”€ buildWindowQuery(table, columns, wf): String
        â”œâ”€ buildWindowQueryOnUnion(t1, t2, cols, wf): String
        â””â”€ executeAndGetCardinality(query): int
```

## Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                SQLancer Framework                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Reused Components:                             â”‚    â”‚
â”‚  â”‚ âœ… SQLite3Provider                             â”‚    â”‚
â”‚  â”‚ âœ… SQLite3TableGenerator                       â”‚    â”‚
â”‚  â”‚ âœ… SQLite3InsertGenerator                      â”‚    â”‚
â”‚  â”‚ âœ… SQLite3Schema                               â”‚    â”‚
â”‚  â”‚ âœ… SQLite3GlobalState                          â”‚    â”‚
â”‚  â”‚ âœ… ExpectedErrors                              â”‚    â”‚
â”‚  â”‚ âœ… Randomly utility                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ New Components:                                â”‚    â”‚
â”‚  â”‚ âœ… SQLite3MRUPOracle                           â”‚    â”‚
â”‚  â”‚ âœ… MRUP enum in SQLite3OracleFactory           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Environment                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Command Line:                                  â”‚    â”‚
â”‚  â”‚ java -jar sqlancer.jar sqlite3 --oracle MRUP  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚               â”‚                                          â”‚
â”‚               â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SQLancer JAR                                   â”‚    â”‚
â”‚  â”‚ - Compiled classes                             â”‚    â”‚
â”‚  â”‚ - Dependencies                                 â”‚    â”‚
â”‚  â”‚ - Resources                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚               â”‚                                          â”‚
â”‚               â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SQLite3 Database Files                         â”‚    â”‚
â”‚  â”‚ ./databases/database-*.db                      â”‚    â”‚
â”‚  â”‚ - Created on-the-fly                           â”‚    â”‚
â”‚  â”‚ - Deleted after testing                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Summary

### âœ… Completed (Phase 1 & 2)

**Phase 1: Schema & Data Generation**
- âœ… Custom `SQLite3MRUPTablePairGenerator`
- âœ… MRUP-compliant schema (dept, salary, age, c0, c1)
- âœ… Disjoint partition data generation (Set A vs Set B)
- âœ… Partition validation (A âˆ© B = âˆ…)
- âœ… Proper row counts (5-20 per table)
- âœ… Data quality (rounded salary, age range, NULL handling)

**Phase 2: Window Function Generation**
- âœ… **C0:** PARTITION BY is MANDATORY (100% of queries)
- âœ… **C1:** PARTITION BY only uses 'dept' column
- âœ… **C2:** ORDER BY only uses 'salary' or 'age'
- âœ… **C3:** No FRAME for ranking functions
- âœ… **C4:** RANGE only with single ORDER BY column
- âœ… **C5:** Only deterministic functions
- âœ… OSRB algorithm implementation
- âœ… Mutation operators (Top 10 strategies)

**Additional Features:**
- âœ… Centralized logging (4 sections)
- âœ… Constraint verification display
- âœ… Bug report generation (`SQLite3MRUPBugReproducer`)
- âœ… Standalone SQL script generation
- âœ… Human-readable README generation

### â³ TODO (Phase 3)

**Phase 3: MRUP Normalization (CRITICAL)**
- âŒ Fix `sortResults()` to use MRUP normalization
- âŒ Sort by: partition â†’ ORDER BY keys â†’ row_number
- âŒ Per-partition comparison
- âŒ Correct NULL handling in sorting
- âŒ Extract window specification info for normalization

**Expected Impact:**
- False positive rate: ~10-20% â†’ <5%
- Real bug detection: Enabled
- MRUP correctness: Guaranteed

### Architecture Principles

The MRUP oracle architecture is:

âœ… **Modular**: Clear separation of concerns (generator, oracle, mutation, bug reporting)  
âœ… **Extensible**: Easy to add features (new constraints, mutations, normalizations)  
âœ… **Reusable**: Leverages SQLancer framework (GlobalState, ExpectedErrors, Randomly)  
âœ… **Testable**: Each component can be tested independently  
âœ… **Maintainable**: Well-documented, clean code, centralized logging  
âœ… **Correct**: Strict constraint enforcement (C0-C5), disjoint partitions guaranteed  

The architecture follows SQLancer's design patterns and integrates seamlessly with the existing framework.

### Key Files

| File | Purpose | Status |
|------|---------|--------|
| `SQLite3MRUPOracle.java` | Main oracle logic | âœ… Phase 1 & 2 complete |
| `SQLite3MRUPTablePairGenerator.java` | Table pair generation | âœ… Phase 1 complete |
| `SQLite3MRUPMutationOperator.java` | Mutation strategies | âœ… Complete |
| `SQLite3MRUPBugReproducer.java` | Bug report generation | âœ… Complete |
| `SQLite3OracleFactory.java` | Oracle registration | âœ… Complete |

### Current Limitations

1. **Comparison Logic (Phase 3 TODO)**
   - Current: Sorts by ALL columns (incorrect)
   - Needed: MRUP normalization (partition â†’ ORDER BY â†’ row_number)
   - Impact: ~10-20% false positives

2. **Window Function Coverage**
   - Current: 8 deterministic functions (ROW_NUMBER, RANK, DENSE_RANK, SUM, AVG, COUNT, MIN, MAX)
   - Future: Could add more window functions (LEAD, LAG, FIRST_VALUE, LAST_VALUE, etc.)

3. **Mutation Coverage**
   - Current: Top 10 mutation strategies
   - Future: Could add remaining 40+ strategies from MRUP.md

### Next Steps

**Immediate (Phase 3):**
1. Implement MRUP normalization algorithm
2. Extract window specification info (PARTITION BY, ORDER BY)
3. Fix `sortResults()` method
4. Add per-partition comparison
5. Test with various window functions

**Future Enhancements:**
1. Add more window functions (LEAD, LAG, etc.)
2. Add more mutation strategies
3. Performance optimization
4. Multi-table support (>2 tables)
5. Cross-DBMS testing (PostgreSQL, MySQL, etc.)

